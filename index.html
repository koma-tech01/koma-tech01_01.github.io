<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>バグトラッキングシステム</title>
  <style>
    body { background:#0f1724; color:#fff; font-family:sans-serif; margin:0; padding:20px; }
    section { display:none; }
    .active { display:block; }
    input, textarea, select {
      background:#1d2738; border:1px solid #2c3a52; color:#fff; padding:8px;
      border-radius:8px; margin-bottom:12px; box-sizing:border-box;
    }
    select option { color:#000; background:#fff; }

    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; margin-top:16px; table-layout:fixed; }

    th, td {
      border-bottom:1px solid #2a3548; padding:12px 8px; vertical-align:middle;
      color:#e2e8f0; overflow:hidden; text-overflow:ellipsis;
    }

    th:nth-child(1), td:nth-child(1) { width:48px; }
    th:nth-child(2), td:nth-child(2) {
      width:600px;
      white-space:normal;
      word-break:break-word;
    }
    th:nth-child(3), td:nth-child(3) { width:110px; }
    th:nth-child(4), td:nth-child(4) { width:110px; }
    th:nth-child(5), td:nth-child(5) { width:110px; text-align:center; }
    th:nth-child(6), td:nth-child(6) { width:90px; }

    tr:hover { background:#1a2536; }
    .btn { padding:8px 12px; background:#1e90ff; color:#fff; border:none; border-radius:6px; cursor:pointer; }

    input, textarea { width: 70%; max-width: 800px; }
    #new input, #new textarea, #new select { display:block; width:70%; margin-bottom:12px; }
    select.short-select { width:auto; min-width:120px; max-width:200px; display:inline-block; }
    #new label { display:block; margin-top:8px; margin-bottom:4px; }
    .empty-row td { text-align:center; color:#9aa4b2; white-space:normal; }

    .detail-wrap { display:flex; gap:20px; align-items:flex-start; }
    #detail-main { flex:1; }
    #comment-side { width:340px; background:transparent; }
    #comment-side .card { background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); }

    #detail-content label{display:block;margin-top:10px;font-weight:bold;}
    #detail-content input,#detail-content textarea,#detail-content select{ width:100%; box-sizing:border-box; margin-top:4px; }

    .comment-list { margin-top:8px; }
    .comment-item { padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; display:flex; justify-content:space-between; gap:8px; }
    .comment-text{ white-space:pre-wrap; color:#e6eef6; }
    .comment-meta{ font-size:12px; color:#9aa4b2; }

    .collapsed-latest { font-style:italic; color:#cbd5e1; }

    /* ログイン画面用のスタイル */
    #login {
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:80vh;
    }
    .login-box {
      background:#1d2738;
      padding:32px;
      border-radius:12px;
      border:1px solid #2c3a52;
      width:100%;
      max-width:400px;
    }
    .login-box h2 {
      margin-top:0;
      text-align:center;
    }
    .login-box input {
      width:100%;
      margin-bottom:16px;
    }
    .login-box .btn {
      width:100%;
    }
    .error-msg {
      color:#ff6b6b;
      font-size:14px;
      margin-top:8px;
      text-align:center;
    }
    #loading {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(15,23,36,0.9);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    #loading.show {
      display:flex;
    }
    .spinner {
      border:4px solid #2c3a52;
      border-top:4px solid #1e90ff;
      border-radius:50%;
      width:50px;
      height:50px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }

    @media (max-width:900px){ .detail-wrap{ flex-direction:column;} #comment-side{ width:100%; } }
  </style>
</head>
<body>

  <!-- ローディング表示 -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ログイン画面 -->
  <section id="login">
    <div class="login-box">
      <h2>バグトラッキングシステム</h2>
      <input id="login-userId" type="text" placeholder="ユーザーID" />
      <input id="login-password" type="password" placeholder="パスワード" />
      <button class="btn" onclick="doLogin()">ログイン</button>
      <div id="login-error" class="error-msg"></div>
    </div>
  </section>

  <nav id="main-nav" style="display:none;margin-bottom:12px;">
    <button class="btn" onclick="go('#list')">一覧</button>
    <button class="btn" id="nav-new" onclick="go('#new')">新規登録</button>
    <button class="btn" onclick="doLogout()" style="margin-left:auto;">ログアウト</button>
    <span id="user-info" style="line-height:32px;margin-left:8px;color:#9aa4b2;"></span>
  </nav>

  <!-- 一覧画面 -->
  <section id="list">
    <h2>バグ一覧</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
      <input id="search" type="text" placeholder="検索 (タイトル・説明・ラベル)" style="flex:1;min-width:220px;" />
    </div>

    <div class="table-wrap">
      <table id="bugTable">
        <thead>
          <tr>
            <th>No.</th>
            <th>タイトル</th>
            <th>ステータス</th>
            <th>重要度</th>
            <th>優先度</th>
            <th>ラベル</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- 新規登録画面 -->
  <section id="new">
    <h2>新しいバグを登録</h2>

    <label for="new-title">タイトル</label>
    <input id="new-title" placeholder="タイトル" />

    <label for="new-desc">説明</label>
    <textarea id="new-desc" placeholder="不具合の再現手順等を記載してください" rows="6"></textarea>

    <label for="new-status">ステータス</label>
    <select id="new-status" class="short-select">
      <option selected>OPEN(新規)</option>
      <option>ACCEPT(アサイン済み)</option>
      <option>RESOLVED(対象方法確定)</option>
      <option>FIXED(修正済み)</option>
      <option>CLOSED(解消)</option>
      <option>INVALID(不具合ではない)</option>
      <option>WONTFIX(仕様扱い)</option>
      <option>DUPLICATE(重複している不具合)</option>
      <option>WORKSFORME(再現しない)</option>
      <option>LATER(次期バージョンで対応)</option>
      <option>REMIND(制限事項扱い)</option>
      <option>REOPENED(再オープン)</option>
    </select>

    <label for="new-labels">ラベル（カンマ区切り）</label>
    <input id="new-labels" placeholder="ラベル (カンマ区切り)" />

    <label>起票者</label>
    <input id="new-reporter" readonly style="background:#0f1724;cursor:not-allowed;" />

    <label for="new-severity">重要度</label>
    <select id="new-severity" class="short-select">
      <option>S(致命的)</option>
      <option>A(機能上問題（回避策なし）)</option>
      <option>B(機能上問題（回避策あり）)</option>
      <option>C(商品性上問題)</option>
      <option>D(軽微)</option>
    </select>

    <label for="new-assignee">担当者</label>
    <input id="new-assignee" placeholder="担当者" />

    <label for="new-priority">優先度</label>
    <select id="new-priority" class="short-select">
      <option selected>High</option>
      <option>Medium</option>
      <option>Low</option>
    </select>

    <label for="new-env">テスト環境</label>
    <input id="new-env" placeholder="テスト環境" />

    <label for="new-version">バージョン情報</label>
    <input id="new-version" placeholder="バージョン情報" />

    <label for="new-repro">再現性</label>
    <input id="new-repro" placeholder="再現性" />

    <label for="new-related">関連チケット</label>
    <input id="new-related" placeholder="関連チケット" />

    <div style="margin-top:8px;">
      <button class="btn" onclick="addBug()">登録</button>
    </div>
  </section>

  <!-- 詳細画面 -->
  <section id="detail">
    <div class="detail-wrap">
      <div id="detail-main">
        <div id="detail-content"></div>
      </div>

      <aside id="comment-side">
        <div class="card">
          <h3 style="margin-top:0;margin-bottom:8px;">開発者コメント</h3>
          <div id="comment-controls" style="margin-bottom:8px;display:flex;gap:8px;align-items:center;">
            <button class="btn" id="toggle-comments-btn" onclick="toggleComments(currentDetailId)">展開/折畳</button>
            <div style="flex:1;text-align:right;color:#9aa4b2;font-size:12px;">新しい順</div>
          </div>

          <div id="comment-collapsed" class="collapsed-latest" style="display:none;padding:8px;">コメントがありません</div>

          <div id="comment-list" class="comment-list" style="display:none;max-height:360px;overflow:auto;"></div>

          <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.03);padding-top:8px;">
            <textarea id="comment-input" rows="3" placeholder="コメントを入力"></textarea>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" onclick="addComment(currentDetailId)">コメント追加</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </section>

<script>
/* ============================
 * 設定
 * ============================ */
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycby7e1wEJeDOnWIFtHZi2Eba67G-XNINESfYzgBqH5Z2SsrqaAbRqkG1W-E8eNzsrN4i/exec';

function callGAS(action, payload) {
  return fetch(GAS_ENDPOINT, {
    method: 'POST',
    body: JSON.stringify({ action, ...payload })
  }).then(r => r.json());
}

/* ============================
 * グローバル
 * ============================ */
let currentUser = null;
let bugsCache = [];
let currentDetailId = null;
let commentsExpanded = {};

/* ============================
 * ローディング
 * ============================ */
function showLoading() { document.getElementById('loading').classList.add('show'); }
function hideLoading() { document.getElementById('loading').classList.remove('show'); }

/* ============================
 * ログイン
 * ============================ */
function doLogin() {
  const userId = login-userId.value.trim();
  const password = login-password.value.trim();
  const err = document.getElementById('login-error');

  if (!userId || !password) {
    err.textContent = 'ユーザーIDとパスワードを入力してください';
    return;
  }

  showLoading();
  callGAS('login', { userId, password })
    .then(r => {
      hideLoading();
      if (!r.success) {
        err.textContent = r.message;
        return;
      }
      currentUser = r;
      login.style.display = 'none';
      main-nav.style.display = 'flex';
      user-info.textContent = `${r.userName} (${r.userType})`;
      loadBugsFromServer();
    });
}

/* ============================
 * 一覧取得
 * ============================ */
function loadBugsFromServer() {
  showLoading();
  callGAS('getBugs', {
    userId: currentUser.userId,
    userType: currentUser.userType
  }).then(r => {
    hideLoading();
    bugsCache = r.bugs || [];
    go('#list');
  });
}

/* ============================
 * ルーティング
 * ============================ */
function go(h) { location.hash = h; }

function route() {
  const hash = location.hash || '#list';
  const clean = hash.split('/')[0];

  document.querySelectorAll('section').forEach(s => {
    s.classList.remove('active');
    s.style.display = 'none';
  });

  const pg = document.querySelector(clean);
  if (pg) {
    pg.classList.add('active');
    pg.style.display = 'block';
  }

  if (clean === '#list') renderList();
  if (clean === '#new') clearNewForm();

  if (clean === '#detail') {
    const id = hash.split('/')[1];
    if (id) showDetail(id);
  }
}
window.addEventListener('hashchange', route);
window.addEventListener('load', route);

/* ============================
 * 一覧（検索対応）
 * ============================ */
function renderList() {
  const q = (document.getElementById('search')?.value || '').toLowerCase();
  const tbody = document.querySelector('#bugTable tbody');
  tbody.innerHTML = '';

  const list = bugsCache.filter(b =>
    JSON.stringify(b).toLowerCase().includes(q)
  );

  if (!list.length) {
    tbody.innerHTML = '<tr><td colspan="6">該当なし</td></tr>';
    return;
  }

  list.forEach((b, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${b.title}</td>
      <td>${b.status}</td>
      <td>${b.severity}</td>
      <td>${b.priority}</td>
      <td>${(b.labels || []).join(', ')}</td>`;
    tr.onclick = () => go(`#detail/${b.id}`);
    tbody.appendChild(tr);
  });
}

/* ============================
 * 新規登録 初期化
 * ============================ */
function clearNewForm() {
  [
    'new-title','new-desc','new-labels','new-env','new-version',
    'new-repro','new-related','new-assignee'
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('new-status').value = 'OPEN(新規)';
}

/* ============================
 * 詳細表示（復活）
 * ============================ */
function showDetail(id) {
  const b = bugsCache.find(x => x.id === id);
  currentDetailId = id;
  const area = document.getElementById('detail-content');
  if (!b) {
    area.textContent = '見つかりません';
    return;
  }

  area.innerHTML = `
    <h2>${b.title}</h2>
    <textarea id="comment-input"></textarea>
    <button onclick="addComment('${b.id}')">コメント追加</button>
    <button onclick="toggleComments('${b.id}')">展開/折畳</button>
    <div id="comment-collapsed"></div>
    <div id="comment-list"></div>
  `;

  renderComments(b);
}

/* ============================
 * コメント表示
 * ============================ */
function renderComments(b) {
  const list = document.getElementById('comment-list');
  const collapsed = document.getElementById('comment-collapsed');

  const cs = (b.comments || []).slice().reverse();
  if (!cs.length) {
    collapsed.textContent = 'コメントなし';
    list.innerHTML = '';
    return;
  }

  collapsed.textContent = cs[0].text;
  list.style.display = commentsExpanded[b.id] ? 'block' : 'none';
  list.innerHTML = '';

  cs.forEach(c => {
    const d = document.createElement('div');
    d.innerHTML = `
      ${c.text}
      <button onclick="deleteComment('${b.id}','${c.id}')">削除</button>`;
    list.appendChild(d);
  });
}

/* ============================
 * コメント操作
 * ============================ */
function toggleComments(id) {
  commentsExpanded[id] = !commentsExpanded[id];
  const b = bugsCache.find(x => x.id === id);
  if (b) renderComments(b);
}

function addComment(id) {
  const ta = document.getElementById('comment-input');
  const text = ta.value.trim();
  if (!text) return;

  const b = bugsCache.find(x => x.id === id);
  b.comments.push({
    id: 'c_' + Math.random().toString(36).slice(2),
    text,
    userName: currentUser.userName,
    createdAt: new Date().toISOString()
  });

  ta.value = '';
  commentsExpanded[id] = true;

  callGAS('saveBug', { bugData: b, userId: currentUser.userId })
    .then(() => renderComments(b));
}

function deleteComment(bugId, cid) {
  const b = bugsCache.find(x => x.id === bugId);
  b.comments = b.comments.filter(c => c.id !== cid);
  callGAS('saveBug', { bugData: b, userId: currentUser.userId })
    .then(() => renderComments(b));
}
</script>

</body>
</html>
