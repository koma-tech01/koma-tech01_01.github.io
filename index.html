<!doctypehtml>
<htmllang="ja">
<head>
<metacharset="utf-8"/>
<metaname="viewport"content="width=device-width,initial-scale=1"/>
<title>L.O.T.U.S</title>
<linkrel="icon"href="data:image/svg+xml,<svgxmlns='http://www.w3.org/2000/svg'viewBox='00100100'><texty='.9em'font-size='90'>ğŸª·</text></svg>">
<style>
body{background:#0f1724;color:#fff;font-family:sans-serif;margin:0;padding:20px;}
section{display:none;}
.active{display:block;}
input,textarea,select{
background:#1d2738;border:1pxsolid#2c3a52;color:#fff;padding:8px;
border-radius:8px;margin-bottom:12px;box-sizing:border-box;
}
selectoption{color:#000;background:#fff;}
.login-boxinput{
background:#3a4a5f;
border:1pxsolid#4a5a6f;
}
.table-wrap{overflow:auto;}
table{width:100%;border-collapse:collapse;margin-top:16px;table-layout:fixed;}
th,td{
border-bottom:1pxsolid#2a3548;padding:12px8px;vertical-align:middle;
color:#e2e8f0;overflow:hidden;text-overflow:ellipsis;
}
th:nth-child(1),td:nth-child(1){width:80px;}
th:nth-child(2),td:nth-child(2){
width:600px;
white-space:normal;
word-break:break-word;
}
th:nth-child(3),td:nth-child(3){width:150px;}
th:nth-child(4),td:nth-child(4){width:150px;}
th:nth-child(5),td:nth-child(5){width:120px;text-align:center;}
tr:hover{background:#1a2536;}
.btn{padding:8px12px;background:#1e90ff;color:#fff;border:none;border-radius:6px;cursor:pointer;}
#new,#detail-content{max-width:800px;margin:0auto;padding:020px;}
input,textarea{width:100%;}
#newinput,#newtextarea,#newselect{display:block;width:100%;margin-bottom:12px;}
select.short-select{width:auto;min-width:120px;max-width:200px;display:inline-block;}
#newlabel{display:block;margin-top:8px;margin-bottom:4px;}
.empty-rowtd{text-align:center;color:#9aa4b2;white-space:normal;}
.detail-wrap{display:flex;gap:20px;align-items:flex-start;max-width:1400px;margin:0auto;}
#detail-main{flex:1;}
#detail-contentlabel{display:block;margin-top:10px;font-weight:bold;}
#detail-contentinput,#detail-contenttextarea,#detail-contentselect{width:100%;box-sizing:border-box;margin-top:4px;}
.comment-section{margin-top:24px;max-width:800px;margin-left:auto;margin-right:auto;}
.comment-list{margin-top:8px;}
.comment-item{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;display:flex;justify-content:space-between;gap:8px;}
.comment-text{white-space:pre-wrap;color:#e6eef6;}
.comment-meta{font-size:12px;color:#9aa4b2;}
.collapsed-latest{font-style:italic;color:#cbd5e1;}
#login{
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
padding:20px;
}
.login-box{
background:#1d2738;
padding:32px;
border-radius:12px;
border:1pxsolid#2c3a52;
width:100%;
max-width:400px;
}
.login-boxh2{
margin-top:0;
text-align:center;
}
.login-boxinput{
width:100%;
margin-bottom:16px;
}
.login-box.btn{
width:100%;
}
.error-msg{
color:#ff6b6b;
font-size:14px;
margin-top:8px;
text-align:center;
}
#loading{
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:rgba(15,23,36,0.9);
display:none;
justify-content:center;
align-items:center;
z-index:9999;
}
#loading.show{
display:flex;
}
.spinner{
border:4pxsolid#2c3a52;
border-top:4pxsolid#1e90ff;
border-radius:50%;
width:50px;
height:50px;
animation:spin1slinearinfinite;
}
@keyframesspin{
0%{transform:rotate(0deg);}
100%{transform:rotate(360deg);}
}
.required::after{
content:'*';
color:#ff6b6b;
font-weight:bold;
}
.bug-link{
color:#1e90ff;
text-decoration:none;
cursor:pointer;
}
.bug-link:hover{
text-decoration:underline;
}
/*é–¢é€£ãƒã‚±ãƒƒãƒˆé¸æŠUI*/
.related-tickets-selector{
border:1pxsolid#2c3a52;
border-radius:8px;
padding:8px;
max-height:200px;
overflow-y:auto;
background:#1d2738;
margin-top:4px;
}
.related-ticket-item{
padding:6px8px;
margin:4px0;
border-radius:4px;
cursor:pointer;
background:rgba(255,255,255,0.03);
display:flex;
align-items:center;
gap:8px;
}
.related-ticket-item:hover{
background:rgba(255,255,255,0.08);
}
.related-ticket-item.selected{
background:rgba(30,144,255,0.3);
border:1pxsolid#1e90ff;
}
.related-ticket-checkbox{
width:16px;
height:16px;
border:2pxsolid#2c3a52;
border-radius:3px;
display:inline-block;
position:relative;
flex-shrink:0;
}
.related-ticket-item.selected.related-ticket-checkbox{
background:#1e90ff;
border-color:#1e90ff;
}
.related-ticket-item.selected.related-ticket-checkbox::after{
content:'âœ“';
position:absolute;
top:-2px;
left:2px;
color:white;
font-size:12px;
}
@media(max-width:900px){.detail-wrap{flex-direction:column;}}
</style>
</head>
<body>
<divid="loading">
<divclass="spinner"></div>
</div>
<sectionid="login">
<divclass="login-box">
<h2>ğŸª·L.O.T.U.S</h2>
<h4>BugTrackingSystem</h4>
<p>
<fontsize="1">
<i>
<b>L</b>ogical
<b>O</b>rganizationof
<b>T</b>asksand
<b>U</b>nresolved
<b>S</b>ituations
</i>
</font>
</p>
<inputid="login-userId"type="text"placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"/>
<inputid="login-password"type="password"placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"/>
<buttonclass="btn"onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
<divid="login-error"class="error-msg"></div>
</div>
</section>
<navid="main-nav"style="display:none;margin-bottom:12px;">
<buttonclass="btn"id="nav-list"onclick="go('#list')"style="display:none;">ä¸€è¦§</button>
<buttonclass="btn"id="nav-new"onclick="go('#new')">æ–°è¦ç™»éŒ²</button>
<buttonclass="btn"onclick="doLogout()"style="margin-left:auto;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
<spanid="user-info"style="line-height:32px;margin-left:8px;color:#9aa4b2;"></span>
</nav>
<sectionid="list">
<h2>ãƒã‚°ä¸€è¦§</h2>
<divstyle="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
<inputid="search"type="text"placeholder="æ¤œç´¢(ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜)"style="flex:1;min-width:220px;"onkeyup="renderList()"/>
</div>
<divclass="table-wrap">
<tableid="bugTable">
<thead>
<tr>
<th>No.</th>
<th>ã‚¿ã‚¤ãƒˆãƒ«</th>
<th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
<th>é‡è¦åº¦</th>
<th>å„ªå…ˆåº¦</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</section>
<sectionid="new">
<h2>æ–°ã—ã„ãƒã‚°ã‚’ç™»éŒ²</h2>
<labelfor="new-status"class="required">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
<selectid="new-status"class="short-select"required>
<optionselected>OPEN(æ–°è¦)</option>
<option>ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)</option>
<option>RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)</option>
<option>FIXED(ä¿®æ­£æ¸ˆã¿)</option>
<option>CLOSED(è§£æ¶ˆ)</option>
<option>INVALID(ä¸å…·åˆã§ã¯ãªã„)</option>
<option>WONTFIX(ä»•æ§˜æ‰±ã„)</option>
<option>DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)</option>
<option>WORKSFORME(å†ç¾ã—ãªã„)</option>
<option>LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)</option>
<option>REMIND(åˆ¶é™äº‹é …æ‰±ã„)</option>
<option>REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)</option>
</select>
<labelfor="new-title"class="required">ã‚¿ã‚¤ãƒˆãƒ«</label>
<inputid="new-title"placeholder="ã‚¿ã‚¤ãƒˆãƒ«"required/>
<labelfor="new-desc"class="required">èª¬æ˜</label>
<textareaid="new-desc"placeholder="ä¸å…·åˆã®å†ç¾æ‰‹é †ç­‰ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"rows="6"required></textarea>
<labelfor="new-repro">å†ç¾æ€§</label>
<inputid="new-repro"placeholder="å†ç¾æ€§"/>
<label>èµ·ç¥¨è€…</label>
<inputid="new-reporter"readonlystyle="background:#0f1724;cursor:not-allowed;"/>
<labelfor="new-assignee"class="required">æ‹…å½“è€…</label>
<inputid="new-assignee"placeholder="æ‹…å½“è€…"required/>
<labelfor="new-severity"class="required">é‡è¦åº¦</label>
<selectid="new-severity"class="short-select"required>
<optionvalue=""selected>é¸æŠã—ã¦ãã ã•ã„</option>
<option>S(è‡´å‘½çš„)</option>
<option>A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)</option>
<option>B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)</option>
<option>C(å•†å“æ€§ä¸Šå•é¡Œ)</option>
<option>D(è»½å¾®)</option>
</select>
<labelfor="new-priority"class="required">å„ªå…ˆåº¦</label>
<selectid="new-priority"class="short-select"required>
<optionvalue=""selected>é¸æŠã—ã¦ãã ã•ã„</option>
<option>High</option>
<option>Medium</option>
<option>Low</option>
</select>
<labelfor="new-env">ãƒ†ã‚¹ãƒˆç’°å¢ƒ</label>
<inputid="new-env"placeholder="ãƒ†ã‚¹ãƒˆç’°å¢ƒ"/>
<labelfor="new-version">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</label>
<inputid="new-version"placeholder="ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±"/>
<labelfor="new-related">é–¢é€£ãƒã‚±ãƒƒãƒˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
<divid="new-related-container"></div>
<divstyle="margin-top:8px;display:flex;gap:8px;">
<buttonclass="btn"onclick="addBug()">ç™»éŒ²</button>
<buttonclass="btn"onclick="go('#list')"style="background:#6c757d;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</section>
<sectionid="detail">
<divclass="detail-wrap">
<divid="detail-main">
<divid="detail-content"></div>
<divclass="comment-section">
<h3style="margin-top:0;margin-bottom:8px;">ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
<divid="comment-controls"style="margin-bottom:8px;display:flex;gap:8px;align-items:center;">
<buttonclass="btn"id="toggle-comments-btn"onclick="toggleComments(currentDetailId)">å±•é–‹/æŠ˜ç•³</button>
<divstyle="flex:1;text-align:right;color:#9aa4b2;font-size:12px;">æ–°ã—ã„é †</div>
</div>
<divid="comment-collapsed"class="collapsed-latest"style="display:none;padding:8px;">ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>
<divid="comment-list"class="comment-list"style="display:none;max-height:360px;overflow:auto;"></div>
<divstyle="margin-top:8px;border-top:1pxsolidrgba(255,255,255,0.03);padding-top:8px;">
<textareaid="comment-input"rows="3"placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
<divstyle="display:flex;gap:8px;margin-top:6px;">
<buttonclass="btn"onclick="addComment(currentDetailId)">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </button>
</div>
</div>
</div>
<h3style="margin-top:24px;max-width:800px;margin-left:auto;margin-right:auto;">å¤‰æ›´å±¥æ­´</h3>
<divid="detail-history"style="font-size:13px;color:#cbd5e1;background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;max-height:200px;overflow:auto;max-width:800px;margin-left:auto;margin-right:auto;"></div>
</div>
</div>
</section>
<script>
constGAS_ENDPOINT='https://script.google.com/macros/s/AKfycbzJSt3uXYr2Dmtv-SyIwEhmEj40Rk8GkZLBJCWF1uHs1jERqbJ6fiSzZNNPhxTePHkM/exec';
functioncallGAS(action,payload){
returnfetch(GAS_ENDPOINT,{
method:'POST',
body:JSON.stringify({action,payload})
}).then(r=>r.json());
}
letcurrentUser=null;
letbugsCache=[];
letcurrentDetailId=null;
letcommentsExpanded={};
letisEditMode=false;
letnavigationHistory=[];
functioncanEditDevFields(){
if(!currentUser)returnfalse;
returncurrentUser.userType==='admin';
}
functioncanEditBug(bug){
if(!currentUser)returnfalse;
if(currentUser.userType==='admin')returntrue;
if(currentUser.userType==='group')returntrue;
if(currentUser.userType==='general'){
returnbug.reporter===currentUser.userId;
}
returnfalse;
}
functionshowLoading(){
document.getElementById('loading').classList.add('show');
}
functionhideLoading(){
document.getElementById('loading').classList.remove('show');
}
functiondoLogin(){
constuserId=document.getElementById('login-userId').value.trim();
constpassword=document.getElementById('login-password').value.trim();
consterrorEl=document.getElementById('login-error');
if(!userId||!password){
errorEl.textContent='ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
return;
}
showLoading();
errorEl.textContent='';
callGAS('authenticate',{userId,password})
.then(result=>{
hideLoading();
if(!result.success){
errorEl.textContent=result.message||'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
return;
}
currentUser={
userId:result.userId,
userName:result.userName,
userType:result.userType
};
document.getElementById('login').style.display='none';
document.getElementById('main-nav').style.display='flex';
letuserTypeLabel='';
if(result.userType==='admin'){
userTypeLabel='ç®¡ç†è€…';
}elseif(result.userType==='group'){
userTypeLabel='ã‚°ãƒ«ãƒ¼ãƒ—';
}else{
userTypeLabel='ä¸€èˆ¬';
}
document.getElementById('user-info').textContent=`${result.userName}(${userTypeLabel})`;
loadBugsFromServer();
})
.catch(e=>{
hideLoading();
errorEl.textContent='é€šä¿¡ã‚¨ãƒ©ãƒ¼:'+e.message;
});
}
functiondoLogout(){
currentUser=null;
bugsCache=[];
location.hash='';
location.reload();
}
functionloadBugsFromServer(){
if(!currentUser)return;
showLoading();
callGAS('getBugs',{
userId:currentUser.userId,
userType:currentUser.userType
})
.then(result=>{
hideLoading();
if(!result.success){
alert(result.message||'èª­ã¿è¾¼ã¿å¤±æ•—');
return;
}
bugsCache=result.bugs||[];
go('#list');
setTimeout(()=>{
window.scrollTo(0,0);
renderList();
},100);
})
.catch(e=>{
hideLoading();
alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼:'+e.message);
});
}
functiongo(hash){
location.hash=hash;
window.scrollTo(0,0);
}
functionclearNewForm(){
constids=['new-title','new-desc','new-env','new-version','new-repro','new-assignee'];
ids.forEach(id=>{
constel=document.getElementById(id);
if(el)el.value='';
});
constreporterEl=document.getElementById('new-reporter');
if(reporterEl&&currentUser){
reporterEl.value=currentUser.userName;
}
conststatus=document.getElementById('new-status');
if(status)status.value='OPEN(æ–°è¦)';
constpriority=document.getElementById('new-priority');
if(priority)priority.value='';
constseverity=document.getElementById('new-severity');
if(severity)severity.value='';
populateRelatedTickets('new-related-container',null,[]);
}
functionpopulateRelatedTickets(containerId,currentBugId,selectedIds){
constcontainer=document.getElementById(containerId);
if(!container)return;
constselected=selectedIds||[];
lethtml='<divclass="related-tickets-selector">';
if(bugsCache.length===0){
html+='<divstyle="padding:8px;color:#9aa4b2;">é–¢é€£ä»˜ã‘å¯èƒ½ãªãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
}else{
bugsCache.forEach(bug=>{
if(bug.id===currentBugId)return;//è‡ªåˆ†è‡ªèº«ã¯é™¤å¤–
constisSelected=selected.includes(bug.id);
html+=`
<divclass="related-ticket-item${isSelected?'selected':''}"
onclick="toggleRelatedTicket('${containerId}','${bug.id}')">
<spanclass="related-ticket-checkbox"></span>
<span>No.${bug.bugNo}-${escapeHtml(bug.title)}</span>
</div>`;
});
}
html+='</div>';
container.innerHTML=html;
}

functiontoggleRelatedTicket(containerId,bugId){
constcontainer=document.getElementById(containerId);
if(!container)return;

constitems=container.querySelectorAll('.related-ticket-item');
items.forEach(item=>{
if(item.textContent.includes(bugId)||item.getAttribute('onclick').includes(bugId)){
item.classList.toggle('selected');
}
});
}

functiongetSelectedRelatedTickets(containerId){
constcontainer=document.getElementById(containerId);
if(!container)return[];

constselectedIds=[];
constitems=container.querySelectorAll('.related-ticket-item.selected');

items.forEach(item=>{
constonclick=item.getAttribute('onclick');
constmatch=onclick.match(/'([^']+)'\)$/);
if(match&&match[1]){
selectedIds.push(match[1]);
}
});

returnselectedIds;
}
functionroute(){
window.scrollTo(0,0);
if(!window.__booted){
window.__booted=true;
document.getElementById('login').style.display='flex';
document.getElementById('login').classList.add('active');
return;
}
consthash=location.hash||'#list';
constclean=hash.split('/')[0];
if(!currentUser&&clean!=='#login'){
location.hash='';
return;
}
document.querySelectorAll('section').forEach(s=>{
s.classList.remove('active');
s.style.display='none';
});
constpg=document.querySelector(clean);
if(pg){
pg.classList.add('active');
pg.style.display='block';
}
constnavNew=document.getElementById('nav-new');
if(navNew){
navNew.style.display=(clean==='#new'||clean==='#detail')?'none':'inline-block';
}
if(clean==='#new'){
clearNewForm();
}
if(clean==='#list'){
renderList();
}
if(clean==='#detail'&&hash.includes('/')){
constbugId=hash.split('/')[1];
showDetail(bugId);
}
}
window.addEventListener('hashchange',route);
window.addEventListener('load',route);
functionrenderList(){
constsearchInput=document.getElementById('search');
constsearch=searchInput?searchInput.value.toLowerCase():'';
consttbody=document.querySelector('#bugTabletbody');
if(!tbody)return;
tbody.innerHTML='';
constsorted=bugsCache.slice().sort((a,b)=>(a.bugNo||0)-(b.bugNo||0));
constfiltered=sorted.filter(b=>{
if(!search)returntrue;
constsearchFields=[
b.title||'',
b.description||'',
b.status||'',
b.severity||'',
b.priority||'',
b.assignee||'',
b.reporterName||''
].join('').toLowerCase();
returnsearchFields.includes(search);
});
if(filtered.length===0){
consttr=document.createElement('tr');
tr.className='empty-row';
tr.innerHTML='<tdcolspan="5">è¡¨ç¤ºã™ã‚‹é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</td>';
tbody.appendChild(tr);
return;
}
filtered.forEach((b)=>{
consttr=document.createElement('tr');
tr.style.cursor='pointer';
tr.innerHTML=`
<td>No.${b.bugNo||'-'}</td>
<td>${escapeHtml(b.title||'')}</td>
<td>${escapeHtml(b.status||'')}</td>
<td>${escapeHtml(b.severity||'')}</td>
<td>${escapeHtml(b.priority||'')}</td>`;
tr.addEventListener('click',()=>{
go(`#detail/${b.id}`);
});
tbody.appendChild(tr);
});
}
functionescapeHtml(s){
return(s||'').replace(/[&<>"']/g,c=>
({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
);
}
functiongoToRelatedBug(bugId){
go(`#detail/${bugId}`);
}

functiongoBackToPrevious(){
//å±¥æ­´ã‹ã‚‰ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤
navigationHistory.pop();

if(navigationHistory.length>0){
//å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
constpreviousBugId=navigationHistory[navigationHistory.length-1];
go(`#detail/${previousBugId}`);
//showDetailãŒå†åº¦å‘¼ã°ã‚Œã‚‹ã®ã§ã€å±¥æ­´é‡è¤‡ã‚’é˜²ããŸã‚æœ€å¾Œã®è¦ç´ ã‚’å‰Šé™¤
navigationHistory.pop();
}else{
//å±¥æ­´ãŒãªã„å ´åˆã¯ä¸€è¦§ã«æˆ»ã‚‹
go('#list');
}
}
functionaddBug(){
if(!currentUser){
alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
return;
}
conststatus=document.getElementById('new-status').value;
consttitle=document.getElementById('new-title').value.trim();
constdescription=document.getElementById('new-desc').value.trim();
constassignee=document.getElementById('new-assignee').value.trim();
constseverity=document.getElementById('new-severity').value;
constpriority=document.getElementById('new-priority').value;
if(!status){
alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}
if(!title){
alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
return;
}
if(!description){
alert('èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
return;
}
if(!assignee){
alert('æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
return;
}
if(!severity){
alert('é‡è¦åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}
if(!priority){
alert('å„ªå…ˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}

constselectedRelated=getSelectedRelatedTickets('new-related-container');
constrelatedId=selectedRelated.join(',');

constb={
id:'b_'+Math.random().toString(36).slice(2,9)+'_'+Date.now(),
bugNo:0,
status:status,
title:title,
description:description,
reproducibility:document.getElementById('new-repro').value,
reporter:currentUser.userId,
reporterName:currentUser.userName,
assignee:assignee,
severity:severity,
priority:priority,
environment:document.getElementById('new-env').value,
version:document.getElementById('new-version').value,
relatedTicket:relatedId,
cause:'',
fixPlan:'',
impact:'',
note:'',
comments:[],
history:[{
type:'create',
at:newDate().toISOString(),
user:currentUser.userName,
data:{}
}],
createdAt:newDate().toISOString()
};
showLoading();
callGAS('saveBug',{bug:b,userId:currentUser.userId})
.then(r=>{
hideLoading();
if(!r.success){
alert(r.message||'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
return;
}
alert('ç™»éŒ²ã—ã¾ã—ãŸ');
loadBugsFromServer();
})
.catch(e=>{
hideLoading();
alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'+e.message);
});
}
functionshowDetail(id,fromHistory){
constb=bugsCache.find(x=>x.id===id);
currentDetailId=id;
isEditMode=false;
constarea=document.getElementById('detail-content');
if(!b){
area.innerHTML='<p>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
return;
}
//å±¥æ­´ç®¡ç†ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‹ã‚‰æ¥ãŸå ´åˆã¯è¿½åŠ ã—ãªã„ï¼‰
if(!fromHistory){
navigationHistory.push(id);
}
b.comments=b.comments||[];
b.history=b.history||[];
renderDetailContent(b,false);
renderHistory(b);
renderComments(b);
constcommentInput=document.getElementById('comment-input');
if(commentInput)commentInput.value='';
}
functionrenderDetailContent(b,editMode){
constarea=document.getElementById('detail-content');
constcanEdit=canEditBug(b);
constcanEditDev=canEditDevFields();
if(editMode&&!canEdit){
editMode=false;
}
constdisabled=editMode?'':'disabled';
constreadonlyStyle=editMode?'':'background:#0f1724;cursor:not-allowed;';
constdevDisabled=(editMode&&canEditDev)?'':'disabled';
constdevReadonlyStyle=(editMode&&canEditDev)?'':'background:#0f1724;cursor:not-allowed;';

letrelatedHtml='';
if(editMode){
relatedHtml='<divid="detail-related-container"></div>';
}else{
if(b.relatedTicket){
constrelatedIds=b.relatedTicket.split(',').filter(x=>x);
if(relatedIds.length>0){
relatedHtml='<divstyle="margin-top:4px;">';
relatedIds.forEach(relId=>{
constrelatedBug=bugsCache.find(x=>x.id===relId);
if(relatedBug){
relatedHtml+=`<div><ahref="javascript:void(0)"onclick="goToRelatedBug('${relatedBug.id}')"class="bug-link">No.${relatedBug.bugNo}-${escapeHtml(relatedBug.title)}</a></div>`;
}
});
relatedHtml+='</div>';
}else{
relatedHtml='<divstyle="margin-top:4px;">ãªã—</div>';
}
}else{
relatedHtml='<divstyle="margin-top:4px;">ãªã—</div>';
}
}

area.innerHTML=`
<divstyle="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
<h2style="margin:0;">ãƒã‚°è©³ç´°(No.${b.bugNo||'-'})</h2>
<divstyle="display:flex;gap:8px;">
${canEdit?
(editMode?
`<buttonclass="btn"onclick="saveDetail('${b.id}')">ä¿å­˜</button>
<buttonclass="btn"onclick="cancelEdit('${b.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`:
`<buttonclass="btn"onclick="toggleEditMode('${b.id}')">ç·¨é›†</button>
<buttonclass="btn"onclick="goBackToPrevious()">æˆ»ã‚‹</button>`
):
`<buttonclass="btn"onclick="goBackToPrevious()">æˆ»ã‚‹</button>`
}
</div>
</div>
<labelclass="required">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
<selectid="detail-status"style="width:260px;${readonlyStyle}"${disabled}>
<option${b.status==='OPEN(æ–°è¦)'?'selected':''}>OPEN(æ–°è¦)</option>
<option${b.status==='ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)'?'selected':''}>ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)</option>
<option${b.status==='RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)'?'selected':''}>RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)</option>
<option${b.status==='FIXED(ä¿®æ­£æ¸ˆã¿)'?'selected':''}>FIXED(ä¿®æ­£æ¸ˆã¿)</option>
<option${b.status==='CLOSED(è§£æ¶ˆ)'?'selected':''}>CLOSED(è§£æ¶ˆ)</option>
<option${b.status==='INVALID(ä¸å…·åˆã§ã¯ãªã„)'?'selected':''}>INVALID(ä¸å…·åˆã§ã¯ãªã„)</option>
<option${b.status==='WONTFIX(ä»•æ§˜æ‰±ã„)'?'selected':''}>WONTFIX(ä»•æ§˜æ‰±ã„)</option>
<option${b.status==='DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)'?'selected':''}>DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)</option>
<option${b.status==='WORKSFORME(å†ç¾ã—ãªã„)'?'selected':''}>WORKSFORME(å†ç¾ã—ãªã„)</option>
<option${b.status==='LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)'?'selected':''}>LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)</option>
<option${b.status==='REMIND(åˆ¶é™äº‹é …æ‰±ã„)'?'selected':''}>REMIND(åˆ¶é™äº‹é …æ‰±ã„)</option>
<option${b.status==='REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)'?'selected':''}>REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)</option>
</select>
<labelclass="required">ã‚¿ã‚¤ãƒˆãƒ«</label>
<inputid="detail-title"value="${escapeHtml(b.title||'')}"${disabled}style="${readonlyStyle}"/>
<labelclass="required">èª¬æ˜</label>
<textareaid="detail-desc"rows="6"${disabled}style="${readonlyStyle}">${escapeHtml(b.description||'')}</textarea>
<label>å†ç¾æ€§</label>
<inputid="detail-repro"value="${escapeHtml(b.reproducibility||'')}"${disabled}style="${readonlyStyle}"/>
<label>èµ·ç¥¨è€…</label>
<inputid="detail-reporter"value="${escapeHtml(b.reporterName||b.reporter||'')}"readonlystyle="background:#0f1724;cursor:not-allowed;"/>
<labelclass="required">æ‹…å½“è€…</label>
<inputid="detail-assignee"value="${escapeHtml(b.assignee||'')}"${disabled}style="${readonlyStyle}"/>
<labelclass="required">é‡è¦åº¦</label>
<selectid="detail-severity"style="width:200px;${readonlyStyle}"${disabled}>
<optionvalue="">é¸æŠã—ã¦ãã ã•ã„</option>
<optionvalue="S(è‡´å‘½çš„)"${b.severity==='S(è‡´å‘½çš„)'?'selected':''}>S(è‡´å‘½çš„)</option>
<optionvalue="A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)"${b.severity==='A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)'?'selected':''}>A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)</option>
<optionvalue="B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)"${b.severity==='B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)'?'selected':''}>B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)</option>
<optionvalue="C(å•†å“æ€§ä¸Šå•é¡Œ)"${b.severity==='C(å•†å“æ€§ä¸Šå•é¡Œ)'?'selected':''}>C(å•†å“æ€§ä¸Šå•é¡Œ)</option>
<optionvalue="D(è»½å¾®)"${b.severity==='D(è»½å¾®)'?'selected':''}>D(è»½å¾®)</option>
</select>
<labelclass="required">å„ªå…ˆåº¦</label>
<selectid="detail-priority"style="width:120px;${readonlyStyle}"${disabled}>
<optionvalue="">é¸æŠã—ã¦ãã ã•ã„</option>
<optionvalue="High"${b.priority==='High'?'selected':''}>High</option>
<optionvalue="Medium"${b.priority==='Medium'?'selected':''}>Medium</option>
<optionvalue="Low"${b.priority==='Low'?'selected':''}>Low</option>
</select>
<label>ãƒ†ã‚¹ãƒˆç’°å¢ƒ</label>
<inputid="detail-env"value="${escapeHtml(b.environment||'')}"${disabled}style="${readonlyStyle}"/>
<label>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</label>
<inputid="detail-version"value="${escapeHtml(b.version||'')}"${disabled}style="${readonlyStyle}"/>
<label>é–¢é€£ãƒã‚±ãƒƒãƒˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
${relatedHtml}
<label>ä¸å…·åˆåŸå› ï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
<textareaid="detail-cause"rows="4"${devDisabled}style="${devReadonlyStyle}">${escapeHtml(b.cause||'')}</textarea>
<label>ä¿®æ­£æ–¹é‡ãƒ»å†…å®¹ï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
<textareaid="detail-fixplan"rows="4"${devDisabled}style="${devReadonlyStyle}">${escapeHtml(b.fixPlan||'')}</textarea>
<label>å½±éŸ¿ç¯„å›²ï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
<textareaid="detail-impact"rows="4"${devDisabled}style="${devReadonlyStyle}">${escapeHtml(b.impact||'')}</textarea>
<label>å‚™è€ƒï¼ˆé–‹ç™ºè€…è¨˜å…¥ï¼‰</label>
<textareaid="detail-note"rows="4"${devDisabled}style="${devReadonlyStyle}">${escapeHtml(b.note||'')}</textarea>
`;

//ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€é–¢é€£ãƒã‚±ãƒƒãƒˆé¸æŠUIã‚’è¡¨ç¤º
if(editMode){
constrelatedIds=(b.relatedTicket||'').split(',').filter(x=>x);
populateRelatedTickets('detail-related-container',b.id,relatedIds);
}
}
functiontoggleEditMode(id){
constb=bugsCache.find(x=>x.id===id);
if(!b)return;
if(!canEditBug(b)){
alert('ã“ã®ãƒã‚°ã‚’ç·¨é›†ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
return;
}
isEditMode=true;
renderDetailContent(b,true);
renderHistory(b);
}
functioncancelEdit(id){
constb=bugsCache.find(x=>x.id===id);
if(!b)return;
isEditMode=false;
renderDetailContent(b,false);
renderHistory(b);
}
functionsaveDetail(id){
if(!currentUser){
alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
return;
}
constb=bugsCache.find(x=>x.id===id);
if(!b){
alert('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
return;
}
if(!canEditBug(b)){
alert('ã“ã®ãƒã‚°ã‚’ç·¨é›†ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
return;
}
constv=(id)=>{
constel=document.getElementById(id);
returnel?el.value.trim():'';
};
conststatus=v('detail-status');
consttitle=v('detail-title');
constdescription=v('detail-desc');
constassignee=v('detail-assignee');
constseverity=v('detail-severity');
constpriority=v('detail-priority');
if(!status){
alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}
if(!title){
alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
return;
}
if(!description){
alert('èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
return;
}
if(!assignee){
alert('æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
return;
}
if(!severity){
alert('é‡è¦åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}
if(!priority){
alert('å„ªå…ˆåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}
constbefore=JSON.parse(JSON.stringify(b));
b.status=status;
b.title=title;
b.description=description;
b.reproducibility=v('detail-repro');
b.assignee=assignee;
b.severity=severity;
b.priority=priority;
b.environment=v('detail-env');
b.version=v('detail-version');

constselectedRelated=getSelectedRelatedTickets('detail-related-container');
b.relatedTicket=selectedRelated.join(',');

if(canEditDevFields()){
b.cause=v('detail-cause');
b.fixPlan=v('detail-fixplan');
b.impact=v('detail-impact');
b.note=v('detail-note');
}
constchanges=[];
constFIELD_LABELS={
status:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
title:'ã‚¿ã‚¤ãƒˆãƒ«',
description:'èª¬æ˜',
reproducibility:'å†ç¾æ€§',
severity:'é‡è¦åº¦',
priority:'å„ªå…ˆåº¦',
assignee:'æ‹…å½“è€…',
environment:'ãƒ†ã‚¹ãƒˆç’°å¢ƒ',
version:'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±',
relatedTicket:'é–¢é€£ãƒã‚±ãƒƒãƒˆ',
cause:'ä¸å…·åˆåŸå› ',
fixPlan:'ä¿®æ­£æ–¹é‡ãƒ»å†…å®¹',
impact:'å½±éŸ¿ç¯„å›²',
note:'å‚™è€ƒ'
};
Object.keys(FIELD_LABELS).forEach(k=>{
if(typeofb[k]==='string'&&before[k]!==b[k]){
letfromValue=before[k]||'';
lettoValue=b[k]||'';

//é–¢é€£ãƒã‚±ãƒƒãƒˆã®å ´åˆã€IDã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«å¤‰æ›
if(k==='relatedTicket'){
fromValue=convertRelatedIdsToTitles(fromValue);
toValue=convertRelatedIdsToTitles(toValue);
}

changes.push({
field:k,
from:fromValue,
to:toValue
});
}
});
if(changes.length){
b.history=b.history||[];
b.history.push({
type:'edit',
at:newDate().toISOString(),
changes:changes,
user:currentUser.userName
});
}
showLoading();
callGAS('saveBug',{bug:b,userId:currentUser.userId})
.then(r=>{
hideLoading();
if(!r.success){
alert(r.message||'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
return;
}
alert('ä¿å­˜ã—ã¾ã—ãŸ');
isEditMode=false;
constindex=bugsCache.findIndex(x=>x.id===id);
if(index!==-1){
bugsCache[index]=b;
}
renderDetailContent(b,false);
renderHistory(b);
})
.catch(e=>{
hideLoading();
alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'+e.message);
});
}
functionconvertRelatedIdsToTitles(idsString){
if(!idsString)return'(ãªã—)';
constids=idsString.split(',').filter(x=>x);
if(ids.length===0)return'(ãªã—)';
consttitles=ids.map(id=>{
constbug=bugsCache.find(x=>x.id===id);
returnbug?`No.${bug.bugNo}-${bug.title}`:id;
});
returntitles.join(',');
}
functionrenderHistory(b){
constbox=document.getElementById('detail-history');
if(!box)return;
box.innerHTML='';
if(!b.history||b.history.length===0){
box.textContent='å¤‰æ›´å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“';
return;
}
constFIELD_LABELS={
status:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
title:'ã‚¿ã‚¤ãƒˆãƒ«',
description:'èª¬æ˜',
reproducibility:'å†ç¾æ€§',
severity:'é‡è¦åº¦',
priority:'å„ªå…ˆåº¦',
reporter:'èµ·ç¥¨è€…',
assignee:'æ‹…å½“è€…',
environment:'ãƒ†ã‚¹ãƒˆç’°å¢ƒ',
version:'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±',
relatedTicket:'é–¢é€£ãƒã‚±ãƒƒãƒˆ',
cause:'ä¸å…·åˆåŸå› ',
fixPlan:'ä¿®æ­£æ–¹é‡ãƒ»å†…å®¹',
impact:'å½±éŸ¿ç¯„å›²',
note:'å‚™è€ƒ'
};
b.history.slice().reverse().forEach(h=>{
constwrap=document.createElement('div');
wrap.style.marginBottom='8px';
consttime=document.createElement('div');
time.style.fontSize='12px';
time.style.color='#9aa4b2';
time.textContent=newDate(h.at).toLocaleString()+(h.user?'-'+h.user:'');
constbody=document.createElement('div');
if(h.type==='create'){
body.textContent='æ–°è¦ä½œæˆ';
}
if(h.type==='edit'&&Array.isArray(h.changes)){
constul=document.createElement('ul');
ul.style.marginLeft='20px';
h.changes.forEach(c=>{
constli=document.createElement('li');
if(typeofc==='string'){
constkey=c.split(':')[0];
constlabel=FIELD_LABELS[key]||key;
li.textContent=c.replace(key,label);
}else{
constlabel=FIELD_LABELS[c.field]||c.field;
li.textContent=`${label}ï¼š${c.from||'(ç©º)'}â†’${c.to||'(ç©º)'}`;
}
ul.appendChild(li);
});
body.appendChild(document.createTextNode('ç·¨é›†'));
body.appendChild(ul);
}
wrap.appendChild(time);
wrap.appendChild(body);
box.appendChild(wrap);
});
}
functionrenderComments(b){
constlist=document.getElementById('comment-list');
constcollapsed=document.getElementById('comment-collapsed');
if(!list||!collapsed)return;
constcs=(b.comments||[]).slice().sort((a,c)=>newDate(c.createdAt)-newDate(a.createdAt));
if(!cs.length){
collapsed.textContent='ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“';
collapsed.style.display='block';
list.style.display='none';
return;
}
collapsed.textContent=cs[0].text;
collapsed.style.display=commentsExpanded[b.id]?'none':'block';
list.innerHTML='';
list.style.display=commentsExpanded[b.id]?'block':'none';
cs.forEach(c=>{
constd=document.createElement('div');
d.className='comment-item';
d.innerHTML=`
<divstyle="flex:1;">
<divclass="comment-text">${escapeHtml(c.text)}</div>
<divclass="comment-meta">${newDate(c.createdAt).toLocaleString()}${c.userName?'-'+c.userName:''}</div>
</div>
<buttonclass="btn"onclick="deleteComment('${b.id}','${c.id}')">å‰Šé™¤</button>`;
list.appendChild(d);
});
}
functiontoggleComments(id){
commentsExpanded[id]=!commentsExpanded[id];
constb=bugsCache.find(x=>x.id===id);
if(b)renderComments(b);
}
functionaddComment(id){
if(!currentUser){
alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
return;
}
constta=document.getElementById('comment-input');
if(!ta)return;
constt=ta.value.trim();
if(!t){
alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
return;
}
constb=bugsCache.find(x=>x.id===id);
if(!b)return;
b.comments=b.comments||[];
b.comments.push({
id:'c_'+Math.random().toString(36).slice(2,9),
text:t,
userName:currentUser.userName,
createdAt:newDate().toISOString()
});
ta.value='';
commentsExpanded[id]=true;
showLoading();
callGAS('saveBug',{bug:b,userId:currentUser.userId})
.then(r=>{
hideLoading();
if(!r.success){
alert(r.message||'ã‚³ãƒ¡ãƒ³ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
return;
}
renderComments(b);
})
.catch(e=>{
hideLoading();
alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'+e.message);
});
}
functiondeleteComment(bugId,cid){
if(!currentUser){
alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
return;
}
if(!confirm('ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
return;
}
constb=bugsCache.find(x=>x.id===bugId);
if(!b)return;
b.comments=b.comments.filter(c=>c.id!==cid);
showLoading();
callGAS('saveBug',{bug:b,userId:currentUser.userId})
.then(r=>{
hideLoading();
if(!r.success){
alert(r.message||'ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
return;
}
renderComments(b);
})
.catch(e=>{
hideLoading();
alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'+e.message);
});
}
</script>
</body>
</html>
