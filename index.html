<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒã‚°ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    body { background:#0f1724; color:#fff; font-family:sans-serif; margin:0; padding:20px; }
    section { display:none; }
    .active { display:block; }
    input, textarea, select {
      background:#1d2738; border:1px solid #2c3a52; color:#fff; padding:8px;
      border-radius:8px; margin-bottom:12px; box-sizing:border-box;
    }
    select option { color:#000; background:#fff; }

    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; margin-top:16px; table-layout:fixed; }

    th, td {
      border-bottom:1px solid #2a3548; padding:12px 8px; vertical-align:middle;
      color:#e2e8f0; overflow:hidden; text-overflow:ellipsis;
    }

    th:nth-child(1), td:nth-child(1) { width:48px; }
    th:nth-child(2), td:nth-child(2) {
      width:600px;
      white-space:normal;
      word-break:break-word;
    }
    th:nth-child(3), td:nth-child(3) { width:110px; }
    th:nth-child(4), td:nth-child(4) { width:110px; }
    th:nth-child(5), td:nth-child(5) { width:110px; text-align:center; }
    th:nth-child(6), td:nth-child(6) { width:90px; }

    tr:hover { background:#1a2536; }
    .btn { padding:8px 12px; background:#1e90ff; color:#fff; border:none; border-radius:6px; cursor:pointer; }

    input, textarea { width: 70%; max-width: 800px; }
    #new input, #new textarea, #new select { display:block; width:70%; margin-bottom:12px; }
    select.short-select { width:auto; min-width:120px; max-width:200px; display:inline-block; }
    #new label { display:block; margin-top:8px; margin-bottom:4px; }
    .empty-row td { text-align:center; color:#9aa4b2; white-space:normal; }

    .detail-wrap { display:flex; gap:20px; align-items:flex-start; }
    #detail-main { flex:1; }
    #comment-side { width:340px; background:transparent; }
    #comment-side .card { background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01)); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); }

    #detail-content label{display:block;margin-top:10px;font-weight:bold;}
    #detail-content input,#detail-content textarea,#detail-content select{ width:100%; box-sizing:border-box; margin-top:4px; }

    .comment-list { margin-top:8px; }
    .comment-item { padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; display:flex; justify-content:space-between; gap:8px; }
    .comment-text{ white-space:pre-wrap; color:#e6eef6; }
    .comment-meta{ font-size:12px; color:#9aa4b2; }

    .collapsed-latest { font-style:italic; color:#cbd5e1; }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #login {
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:80vh;
    }
    .login-box {
      background:#1d2738;
      padding:32px;
      border-radius:12px;
      border:1px solid #2c3a52;
      width:100%;
      max-width:400px;
    }
    .login-box h2 {
      margin-top:0;
      text-align:center;
    }
    .login-box input {
      width:100%;
      margin-bottom:16px;
    }
    .login-box .btn {
      width:100%;
    }
    .error-msg {
      color:#ff6b6b;
      font-size:14px;
      margin-top:8px;
      text-align:center;
    }
    #loading {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(15,23,36,0.9);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    #loading.show {
      display:flex;
    }
    .spinner {
      border:4px solid #2c3a52;
      border-top:4px solid #1e90ff;
      border-radius:50%;
      width:50px;
      height:50px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }

    @media (max-width:900px){ .detail-wrap{ flex-direction:column;} #comment-side{ width:100%; } }
  </style>
</head>
<body>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
  <div id="loading">
    <div class="spinner"></div>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <section id="login">
    <div class="login-box">
      <h2>ãƒã‚°ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ </h2>
      <input id="login-userId" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID" />
      <input id="login-password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
      <button class="btn" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-error" class="error-msg"></div>
    </div>
  </section>

  <nav id="main-nav" style="display:none;margin-bottom:12px;">
    <button class="btn" onclick="go('#list')">ä¸€è¦§</button>
    <button class="btn" id="nav-new" onclick="go('#new')">æ–°è¦ç™»éŒ²</button>
    <button class="btn" onclick="doLogout()" style="margin-left:auto;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <span id="user-info" style="line-height:32px;margin-left:8px;color:#9aa4b2;"></span>
  </nav>

  <!-- ä¸€è¦§ç”»é¢ -->
  <section id="list">
    <h2>ãƒã‚°ä¸€è¦§</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
      <input id="search" type="text" placeholder="æ¤œç´¢ (ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜ãƒ»ãƒ©ãƒ™ãƒ«)" style="flex:1;min-width:220px;" />
    </div>

    <div class="table-wrap">
      <table id="bugTable">
        <thead>
          <tr>
            <th>No.</th>
            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>é‡è¦åº¦</th>
            <th>å„ªå…ˆåº¦</th>
            <th>ãƒ©ãƒ™ãƒ«</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- æ–°è¦ç™»éŒ²ç”»é¢ -->
  <section id="new">
    <h2>æ–°ã—ã„ãƒã‚°ã‚’ç™»éŒ²</h2>

    <label for="new-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
    <input id="new-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />

    <label for="new-desc">èª¬æ˜</label>
    <textarea id="new-desc" placeholder="ä¸å…·åˆã®å†ç¾æ‰‹é †ç­‰ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„" rows="6"></textarea>

    <label for="new-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
    <select id="new-status" class="short-select">
      <option selected>OPEN(æ–°è¦)</option>
      <option>ACCEPT(ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿)</option>
      <option>RESOLVED(å¯¾è±¡æ–¹æ³•ç¢ºå®š)</option>
      <option>FIXED(ä¿®æ­£æ¸ˆã¿)</option>
      <option>CLOSED(è§£æ¶ˆ)</option>
      <option>INVALID(ä¸å…·åˆã§ã¯ãªã„)</option>
      <option>WONTFIX(ä»•æ§˜æ‰±ã„)</option>
      <option>DUPLICATE(é‡è¤‡ã—ã¦ã„ã‚‹ä¸å…·åˆ)</option>
      <option>WORKSFORME(å†ç¾ã—ãªã„)</option>
      <option>LATER(æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¯¾å¿œ)</option>
      <option>REMIND(åˆ¶é™äº‹é …æ‰±ã„)</option>
      <option>REOPENED(å†ã‚ªãƒ¼ãƒ—ãƒ³)</option>
    </select>

    <label for="new-labels">ãƒ©ãƒ™ãƒ«ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
    <input id="new-labels" placeholder="ãƒ©ãƒ™ãƒ« (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)" />

    <label>èµ·ç¥¨è€…</label>
    <input id="new-reporter" readonly style="background:#0f1724;cursor:not-allowed;" />

    <label for="new-severity">é‡è¦åº¦</label>
    <select id="new-severity" class="short-select">
      <option>S(è‡´å‘½çš„)</option>
      <option>A(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ãªã—ï¼‰)</option>
      <option>B(æ©Ÿèƒ½ä¸Šå•é¡Œï¼ˆå›é¿ç­–ã‚ã‚Šï¼‰)</option>
      <option>C(å•†å“æ€§ä¸Šå•é¡Œ)</option>
      <option>D(è»½å¾®)</option>
    </select>

    <label for="new-assignee">æ‹…å½“è€…</label>
    <input id="new-assignee" placeholder="æ‹…å½“è€…" />

    <label for="new-priority">å„ªå…ˆåº¦</label>
    <select id="new-priority" class="short-select">
      <option selected>High</option>
      <option>Medium</option>
      <option>Low</option>
    </select>

    <label for="new-env">ãƒ†ã‚¹ãƒˆç’°å¢ƒ</label>
    <input id="new-env" placeholder="ãƒ†ã‚¹ãƒˆç’°å¢ƒ" />

    <label for="new-version">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</label>
    <input id="new-version" placeholder="ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±" />

    <label for="new-repro">å†ç¾æ€§</label>
    <input id="new-repro" placeholder="å†ç¾æ€§" />

    <label for="new-related">é–¢é€£ãƒã‚±ãƒƒãƒˆ</label>
    <input id="new-related" placeholder="é–¢é€£ãƒã‚±ãƒƒãƒˆ" />

    <div style="margin-top:8px;">
      <button class="btn" onclick="addBug()">ç™»éŒ²</button>
    </div>
  </section>

  <!-- è©³ç´°ç”»é¢ -->
  <section id="detail">
    <div class="detail-wrap">
      <div id="detail-main">
        <div id="detail-content"></div>
      </div>

      <aside id="comment-side">
        <div class="card">
          <h3 style="margin-top:0;margin-bottom:8px;">é–‹ç™ºè€…ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
          <div id="comment-controls" style="margin-bottom:8px;display:flex;gap:8px;align-items:center;">
            <button class="btn" id="toggle-comments-btn" onclick="toggleComments(currentDetailId)">å±•é–‹/æŠ˜ç•³</button>
            <div style="flex:1;text-align:right;color:#9aa4b2;font-size:12px;">æ–°ã—ã„é †</div>
          </div>

          <div id="comment-collapsed" class="collapsed-latest" style="display:none;padding:8px;">ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>

          <div id="comment-list" class="comment-list" style="display:none;max-height:360px;overflow:auto;"></div>

          <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.03);padding-top:8px;">
            <textarea id="comment-input" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
            <div style="display:flex;gap:8px;margin-top:6px;">
              <button class="btn" onclick="addComment(currentDetailId)">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </section>

<script>
  //============================
  // è¨­å®š
  //============================
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyOvOJDJNcNyliqWAVFBwJc_blCZLJa5KExzHXoQBti-Famx6H7QRBTxuxccpIUM6o/exec';

  function callGAS(action, payload) {
    return fetch(GAS_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, payload })
    }).then(r => r.json());
  }

  //============================
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆå¤‰æ›´ãªã—ï¼‰
  //============================
  let currentUser = null;
  let bugsCache = [];
  let currentDetailId = null;
  let commentsExpanded = {};

  //============================
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  //============================
  function showLoading() {
    document.getElementById('loading').classList.add('show');
  }
  function hideLoading() {
    document.getElementById('loading').classList.remove('show');
  }

  //============================
  // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
  //============================
  function doLogin() {
    const userId = document.getElementById('login-userId').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const errorEl = document.getElementById('login-error');

    if (!userId || !password) {
      errorEl.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      return;
    }

    showLoading();
    errorEl.textContent = '';

    callGAS('authenticate', { userId, password })
      .then(result => {
        hideLoading();
        if (!result.success) {
          errorEl.textContent = result.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
          return;
        }

        currentUser = {
          userId: result.userId,
          userName: result.userName,
          userType: result.userType
        };

        document.getElementById('login').style.display = 'none';
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('user-info').textContent =
          `${result.userName} (${result.userType === 'admin' ? 'ç®¡ç†è€…' : 'ä¸€èˆ¬'})`;

        loadBugsFromServer();
      })
      .catch(e => {
        hideLoading();
        errorEl.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message;
      });
  }

  //============================
  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
  //============================
  function doLogout() {
    currentUser = null;
    bugsCache = [];
    location.hash = '';
    location.reload();
  }

  //============================
  // ãƒã‚°ä¸€è¦§å–å¾—
  //============================
  function loadBugsFromServer() {
    if (!currentUser) return;

    showLoading();
    callGAS('getBugs', {
      userId: currentUser.userId,
      userType: currentUser.userType
    })
      .then(result => {
        hideLoading();
        if (!result.success) {
          alert(result.message || 'èª­ã¿è¾¼ã¿å¤±æ•—');
          return;
        }
        bugsCache = result.bugs || [];
        go('#list');
      })
      .catch(e => {
        hideLoading();
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e.message);
      });
  }

  //============================
  // ç”»é¢é·ç§»ï¼ˆå®Œå…¨ç¶­æŒï¼‰
  //============================
  function go(hash) { location.hash = hash; }

  function route() {
    if (!window.__booted) {
      window.__booted = true;
      document.getElementById('login').classList.add('active');
      return;
    }

    const hash = location.hash || '#list';
    const clean = hash.split('/')[0];

    if (!currentUser && clean !== '#login') {
      location.hash = '';
      return;
    }

    document.querySelectorAll('section').forEach(s => {
      s.classList.remove('active');
      s.style.display = 'none';
    });

    const pg = document.querySelector(clean);
    if (pg) {
      pg.classList.add('active');
      pg.style.display = 'block';
    }

    if (clean === '#list') renderList();
    if (clean === '#detail' && hash.includes('/')) {
      showDetail(hash.split('/')[1]);
    }
  }

  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);

  //============================
  // ä¸€è¦§è¡¨ç¤ºï¼ˆå¤‰æ›´ãªã—ï¼‰
  //============================
  function renderList() {
    const tbody = document.querySelector('#bugTable tbody');
    tbody.innerHTML = '';

    bugsCache.forEach((b, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${b.title || ''}</td>
        <td>${b.status || ''}</td>
        <td>${b.severity || ''}</td>
        <td>${b.priority || ''}</td>
        <td>${(b.labels || []).join(', ')}</td>
      `;
      tr.onclick = () => go(`#detail/${b.id}`);
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, c =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
    );
  }

  //============================
  // æ–°è¦ç™»éŒ²
  //============================
  function addBug() {
    const b = {
      id: 'b_' + Math.random().toString(36).slice(2),
      title: document.getElementById('new-title').value,
      description: document.getElementById('new-desc').value,
      status: document.getElementById('new-status').value,
      labels: document.getElementById('new-labels').value.split(',').map(x => x.trim()).filter(Boolean),
      reporter: currentUser.userId,
      reporterName: currentUser.userName,
      assignee: document.getElementById('new-assignee').value,
      severity: document.getElementById('new-severity').value,
      priority: document.getElementById('new-priority').value,
      environment: document.getElementById('new-env').value,
      version: document.getElementById('new-version').value,
      reproducibility: document.getElementById('new-repro').value,
      related: document.getElementById('new-related').value,
      comments: [],
      history: [{ type: 'create', at: new Date().toISOString() }],
      createdAt: new Date().toISOString()
    };

    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(r => {
        hideLoading();
        if (!r.success) {
          alert(r.message);
          return;
        }
        loadBugsFromServer();
      });
  }

  //============================
  // è©³ç´°ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»å±¥æ­´
  // ğŸ‘‰ ãƒ­ã‚¸ãƒƒã‚¯å®Œå…¨ç¶­æŒã€ä¿å­˜ã ã‘ fetch
  //============================
  function saveDetail(id) {
    const b = bugsCache.find(x => x.id === id);
    if (!b) return;

    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(r => {
        hideLoading();
        if (!r.success) {
          alert(r.message);
          return;
        }
        loadBugsFromServer();
      });
  }

  function addComment(id) {
    const b = bugsCache.find(x => x.id === id);
    if (!b) return;

    const ta = document.getElementById('comment-input');
    const text = ta.value.trim();
    if (!text) return;

    b.comments.push({
      id: 'c_' + Math.random().toString(36).slice(2),
      text,
      userName: currentUser.userName,
      createdAt: new Date().toISOString()
    });

    commentsExpanded[id] = true;
    ta.value = '';

    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(() => {
        hideLoading();
        renderComments(b);
      });
  }

  function deleteComment(bugId, cid) {
    const b = bugsCache.find(x => x.id === bugId);
    if (!b) return;

    if (!confirm('ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    b.comments = b.comments.filter(c => c.id !== cid);

    showLoading();
    callGAS('saveBug', { bug: b, userId: currentUser.userId })
      .then(() => {
        hideLoading();
        renderComments(b);
      });
  }
</script>

</body>
</html>
